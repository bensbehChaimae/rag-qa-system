# Docker Setup for RAG Document Q/A System

This directory provides a complete **Dockerized environment** for the RAG-powered Document Question Answering application.  
It includes all required services for application runtime, data storage, background processing, and monitoring.



## Services Overview

- **FastAPI (Uvicorn)** – Core API service for handling document queries and responses.
- **Nginx** – Reverse proxy and load balancer for serving the FastAPI application.
- **PostgreSQL (pgvector extension)** – Relational database with vector support for storing embeddings and metadata.
- **Postgres Exporter** – Exposes PostgreSQL metrics to Prometheus.
- **Qdrant** – High-performance vector database for similarity search and retrieval.
- **Prometheus** – Monitoring and metrics collection service.
- **Grafana** – Visualization and dashboarding tool for system and application metrics.
- **Node Exporter** – Collects system-level metrics for Prometheus.
- **Celery Worker** – Executes asynchronous background tasks.
- **Celery Beat** – Scheduler for periodic tasks in Celery.
- **Flower** – Web UI for monitoring Celery tasks and workers.
- **RabbitMQ** – Message broker used by Celery for task queuing.
- **Redis** – In-memory data store for caching and task management.



### Notes

- The setup is modular: you can enable/disable services depending on your use case.  
- Monitoring is handled via the **Prometheus–Grafana stack**.  
- Background task management relies on the **Celery–RabbitMQ–Redis stack**.  




## Setup Instructions

### 1. Set up environment files

Create your environment files from the examples:

```bash
# Create all required .env files from examples
cd docker/env
cp .env.example.app .env.app
cp .env.example.postgres .env.postgres
cp .env.example.grafana .env.grafana
cp .env.example.postgres-exporter .env.postgres-exporter

# Setup the Alembic configuration for the FastAPI application
cd ..
cd docker/ragdb
cp alembic.example.ini alembic.ini

### 2. Start the services

```bash
cd docker
docker compose up --build -d
```

To start only specific services:

```bash
docker compose up -d fastapi nginx pgvector qdrant
```

If you encounter connection issues, you may want to start the database services first and let them initialize before starting the application:

```bash
# Start databases first
docker compose up -d pgvector qdrant postgres-exporter
# Wait for databases to be healthy
sleep 30
# Start the application services
docker compose up fastapi nginx prometheus grafana node-exporter --build -d
```

In case deleting all containers and volumes is necessary, you can run:

```bash
docker compose down -v --remove-orphans
```

### 3. Access the services

- FastAPI Application: http://localhost:8000
- FastAPI Documentation: http://localhost:8000/docs
- Nginx (serving FastAPI): http://localhost
- Prometheus: http://localhost:9090
- Grafana: http://localhost:3000
- Qdrant UI: http://localhost:6333/dashboard
- Rabbitmq: http://localhost:15672 
- Flower: http://localhost:5555  




## Volume Management

### Managing Docker Volumes

Docker volumes are used to persist data generated by and used by Docker containers. Here are some commands to manage your volumes:

1. **List all volumes**:
   ```bash
   docker volume ls
   ```
2. **Inspect a volume**:
   ```bash
   docker volume inspect <volume_name>
   ```

   - list files in a volume:
   ```bash
   docker run --rm -v <volume_name>:/data busybox ls -l /data
   ```

3. **Remove a volume**:
   ```bash
   docker volume rm <volume_name>
   ```
4. **Prune unused volumes**:
   ```bash
    docker volume prune
    ```

5. **Backup volume for migration**:
   ```bash
    docker run --rm -v <volume_name>:/volume -v $(pwd):/backup alpine tar cvf /backup/backup.tar /volume
    ```

6. **Restore volume from backup**:
   ```bash
    docker run --rm -v <volume_name>:/volume -v $(pwd):/backup alpine sh -c "cd /volume && tar xvf /backup/backup.tar --strip 1"
    ```

7. **Remove all volumes**:
    ```bash
    docker volume rm $(docker volume ls -q)
    ```

**NOTE**: For PostgreSQL specifically, you might want to consider using PostgreSQL's built-in tools like `pg_dump` and `pg_restore` for more reliable backups, especially for live databases.

## Monitoring

### FastAPI Metrics

FastAPI is configured to expose Prometheus metrics at the `/metrics` endpoint. These metrics include:

- Request counts
- Request latencies
- Status codes

Prometheus is configured to scrape these metrics automatically.

### Visualizing Metrics in Grafana

1. Log into Grafana at http://localhost:3000 (credentials set up on `/docker/env/.env.grafana`)
2. Add Prometheus as a data source (URL: http://prometheus:9090)
3. Import dashboards for FastAPI, PostgreSQL, and Qdrant

#### Dashboards URLs :

- **FastAPI Observability**:  
  https://grafana.com/grafana/dashboards/18739-fastapi-observability/

- **Node Exporter (System Metrics)**:  
  https://grafana.com/grafana/dashboards/1860-node-exporter-full/

- **PostgreSQL Exporter**:  
  https://grafana.com/grafana/dashboards/12485-postgresql-exporter/

- **Qdrant**:  
  No official pre-built Grafana dashboard is available for Qdrant.  
  You can create custom dashboards tailored to your metrics and use cases.


### Celery Task Monitoring with Flower

- **Flower UI** is available at: [http://localhost:5555](http://localhost:5555)  
  Flower provides a real-time dashboard for monitoring Celery tasks, including:  
  - Task execution status (pending, started, success, failure)  
  - Worker health and availability  
  - Task runtime and throughput  
  - Retry and failure insights  

- **RabbitMQ Management UI** is available at: [http://localhost:15672](http://localhost:15672)  
  It provides insights into the message broker, queues, and Celery task traffic.




## Development Workflow

The FastAPI application is configured with hot-reloading. Any changes to the code in the `src/` directory will automatically reload the application.

## Troubleshooting

### Connection Errors

If you see connection errors when starting the services:

1. **Database Connection Refused**: This often happens when the FastAPI app tries to connect to databases before they're ready.
   ```
   Connection refused: [Errno 111] Connection refused
   ```
   
   Solutions:
   - Start database services first, wait, then start the application
   - Check database logs: `docker compose logs pgvector`
   - Ensure your database credentials in `.env.app` match those in `.env.postgres`

2. **Restart the FastAPI service** after databases are running:
   ```bash
   docker compose restart fastapi
   ```

3. **Check service status**:
   ```bash
   docker compose ps
   ```

4. **View logs** for more details:
   ```bash
   docker compose logs --tail=100 fastapi
   docker compose logs --tail=100 pgvector
   ```

